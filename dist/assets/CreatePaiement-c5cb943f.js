import{_ as I,x as N,k as h,o as a,c as d,b as o,m as f,p as x,F as w,f as F,h as g,t as p,z as P,l as S,n as D,g as _,a2 as T,a3 as A}from"./index-8845255c.js";/* empty css                    */const M=N.useToast(),U={data(){return{selectedEleve:{selectedMonths:[],selectedCredit:!1,services:[]},fraisInscriptionPrice:"",selectedEleveName:"",isEleveSelected:!1,isDropdownOpen:!1,eleves:[],selectedGroupeName:"",filteredGroupes:[],selectedGroupe:null,familles:[],paiements:[],paymentMethods:["Espèce","Chèque","TPE"],selectedPaymentMethods:[],paymentMethodPrices:{Espèce:"",Chèque:"",TPE:""},fraisInscriptionPaid:!1,filteredEleves:[],months:["Sept","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May","June","July"],avance:"0.00",reste:"0.00",modePaiement:"",referenceNumber:""}},computed:{totalAmount(){let e=0;return this.selectedEleve.selectedMonths.forEach(s=>{e+=parseFloat(this.selectedEleve[s])}),this.selectedEleve.selectedFraisInscription&&(e+=parseFloat(this.fraisInscriptionPrice)),this.selectedEleve.selectedCredit&&(e+=parseFloat(this.creditPrice)),this.avance=e.toFixed(2),e.toFixed(2)},reste(){return(parseFloat(this.totalAmount)-parseFloat(this.avance)).toFixed(2)},hasUncompletedPayments(){return this.paiements.some(e=>e.status==="Not completed")},creditPrice(){return this.hasUncompletedPayments?parseFloat(this.getTotalUncompletedReste()):0}},methods:{isMonthPending(e){if(this.selectedEleve&&this.selectedEleve.selectedMonths&&this.paiements){const s=this.paiements.filter(c=>c.pending===1);for(const c of s)if(c.services.find(t=>t.type==="mensuel"&&t.service==="Frais scolarité"&&t.pivot.month===e||t.type==="mensuel"&&t.service==="Transport"&&t.pivot.month===e))return!0}return!1},isFraisInscriptionPending(){if(this.selectedEleve&&this.paiements){const e=this.paiements.filter(s=>s.pending===!0);for(const s of e)if(s.services.find(r=>r.type==="annuel"&&r.service==="Frais d'inscription"&&r.pivot.month==="Sept"))return!0}return!1},toggleDropdown(){this.isDropdownOpen=!this.isDropdownOpen},handleCreditCheckboxChange(){this.selectedEleve.selectedCredit?(this.avance=this.creditPrice.toFixed(2),this.reste="0.00"):(this.avance="0.00",this.reste=(parseFloat(this.totalAmount)-parseFloat(this.avance)).toFixed(2))},async submitPayment(){let e=parseFloat(this.avance);if(this.selectedEleve.selectedCredit){let s=e;const c=this.paiements.slice().sort((r,t)=>new Date(r.created_at)-new Date(t.created_at));for(const r of c){if(e<=0)break;if(r.status==="Not completed"){const t=parseFloat(r.reste),n=Math.min(e,t);r.avance=(parseFloat(r.avance)+n).toFixed(2),r.reste=(t-n).toFixed(2),r.reste<=0&&(r.status="Completed"),await h.put(`/comptable/update-payment/${r.id}`,{avance:r.avance,reste:r.reste,status:r.status}),e-=n}}this.selectedEleve.services.slice().sort((r,t)=>{const n=["Frais d'inscription","Frais scolarité","Transport"];return n.indexOf(r.service)-n.indexOf(t.service)});for(const r of c){if(console.log("originalTotalAvance, ",s),s<=0)break;for(const t of r.services)if(t.pivot.status==="Not Completed"){const n=parseFloat(t.pivot.reste),i=Math.min(s,n);t.pivot.avance=(parseFloat(t.pivot.avance)+i).toFixed(2),t.pivot.reste=(n-i).toFixed(2),t.pivot.reste<=0&&(t.pivot.status="Completed"),await h.put(`/comptable/paiementService/${t.pivot.id}`,{avance:t.pivot.avance,reste:t.pivot.reste,status:t.pivot.status}),s-=i}}}if(e>0){const s={};let c=!1;for(const t of this.selectedPaymentMethods)if(t==="Chèque"){c=!0;break}const r={montant:this.totalAmount,avance:this.avance,reste:this.reste,mode:this.modePaiement,num_cheque:this.referenceNumber,status:this.reste>0?"Not completed":"completed",pending:c,eleve_id:this.selectedEleve.id};try{const t=await h.post("/comptable/create-paiement",r);t.status===201&&M.success("Payment created successfully!",{position:"bottom-right",duration:3e3});const n=t.data.id;for(const i of this.selectedPaymentMethods){const m=this.paymentMethodPrices[i];if(m>0){const u={type:i,montant:m,paid:i!=="Chèque",ref:i==="Chèque"?this.referenceNumber:null,paiement_id:n};await h.post("/comptable/create-mode",u)}}console.log("paiementId, ",this.selectedEleve.selectedMonths);for(const i of this.selectedEleve.selectedMonths){if(console.log(this.selectedEleve.selectedFraisInscription),this.selectedEleve.selectedFraisInscription&&i==="Sept"){const l=this.selectedEleve.services.find(v=>v.type==="annuel"&&v.service==="Frais d'inscription");if(console.log("fraisInscriptionService, ",l),l){const v=l.pivot.price,y=Math.min(e,v),E=v-y,C=E>0?"Not Completed":"Completed",k={paiement_id:n,service_id:l.id,month:i,price:v,avance:y,reste:E,status:C,paid:y>0};await h.post("/comptable/create-paiement-service",k),e-=y}}const m=this.selectedEleve.services.find(l=>l.type==="mensuel"&&l.service==="Frais scolarité");if(m){const l=Math.min(e,m.pivot.price);s[m.id]=l,e-=l}const u=this.selectedEleve.services.find(l=>l.type==="mensuel"&&l.service==="Transport");if(u){const l=Math.min(e,u.pivot.price);s[u.id]=l,e-=l}for(const l of this.selectedEleve.services)if(s.hasOwnProperty(l.id)||l.type==="mensuel"&&(l.service==="Frais scolarité"||l.service==="Transport")){const v=l.pivot.price,y=s[l.id]||0,E=v-y,C=E>0?"Not Completed":"Completed",k={paiement_id:n,service_id:l.id,month:i,price:v,avance:y,reste:E,status:C,paid:y>0};await h.post("/comptable/create-paiement-service",k)}}M.success("Payment created successfully!",{position:"bottom-right",duration:3e3})}catch{M.error("An error occurred",{position:"bottom-right",duration:3e3})}}},async fetchPaiementsWithServices(){try{const e=await h.get(`/comptable/eleves/${this.selectedEleve.id}/paiements`);this.paiements=e.data,console.log("this.paiements, ",this.paiements)}catch(e){console.error("Error fetching paiements:",e)}},isFraisInscriptionExisting(){for(const e of this.paiements)for(const s of e.services)if(s.type==="annuel"&&s.service==="Frais d'inscription")return!0;return!1},isMonthExisting(e){for(const s of this.paiements)for(const c of s.services)if(c.pivot.month===e)return!0;return!1},getTotalUncompletedReste(){let e=0;for(const s of this.paiements)s.status==="Not completed"&&(e+=parseFloat(s.reste));return e.toFixed(2)},async fetchFamilles(){try{const e=await h.get("/comptable/parents");this.familles=e.data}catch(e){console.error("Error loading familles:",e)}},async fetchPaiementsForEleve(e){try{const s=await h.get(`/comptable/paiements/${e.id}`);e.paiements=s.data}catch(s){console.error("Error loading paiements for eleve:",s)}},filterEleves(){if(!this.selectedEleveName){this.filteredEleves=[];return}this.filteredEleves=this.eleves.filter(e=>e.prenom.toLowerCase().includes(this.selectedEleveName.toLowerCase())||e.nom.toLowerCase().includes(this.selectedEleveName.toLowerCase()))},async selectEleve(e){this.selectedEleve={...e,selectedMonths:[],services:[]},this.selectedEleveName=`${e.prenom} ${e.nom}`,this.filteredEleves=[],await this.fetchServicesForEleve(),await this.fetchPaiementsWithServices(),this.isEleveSelected=!0,this.isDropdownOpen=!0},async fetchServicesForEleve(){try{const e=await h.get(`/comptable/eleves/${this.selectedEleve.id}/services`);this.selectedEleve.services=e.data,this.calculateTotalPrice(),this.calculateFraisInscriptionPrice()}catch(e){console.error("Error loading services:",e)}},calculateFraisInscriptionPrice(){const e=this.selectedEleve.services.find(s=>s.type==="annuel"&&s.service==="Frais d'inscription");console.log("fraisInscriptionService, ",e),e?this.fraisInscriptionPrice=parseFloat(e.pivot.price):this.fraisInscriptionPrice=0},calculateTotalPrice(){if(this.selectedEleve.services&&this.selectedEleve.services.length>0){const e=this.selectedEleve.services.filter(c=>c.type==="mensuel");let s=0;e.forEach(c=>{s+=parseFloat(c.pivot.price)}),this.selectedEleve.totalPrice=s,this.months.forEach(c=>{this.selectedEleve[c]=s})}else this.selectedEleve.totalPrice=0},getPriceForMonth(e){return this.selectedEleve?this.selectedEleve[e]:""},async loadEleves(){try{const e=await h.get("/comptable/eleves");this.eleves=e.data}catch(e){console.error("Error loading eleves:",e)}}},async mounted(){this.loadEleves(),await this.fetchPaiementsWithServices(),this.handleCreditCheckboxChange()}},b=e=>(T("data-v-f4ecff51"),e=e(),A(),e),V={class:"w-full px-4 py-8 mx-80"},O=b(()=>o("span",{class:"text-base font-semibold mx-4"},"Selectionner un eleve",-1)),q={key:0,class:"absolute z-10 mt-1 w-1/4 bg-white border border-blueGray-300 rounded-lg shadow-md mx-48"},R=["onClick"],G={class:"flex justify-center items-center h-screen bg-gray-100"},L={key:0,class:"max-w-lg w-full md:w-1/2 mx-2 my-8 mb-4 md:mb-0 overflow-y-auto h-auto"},j={class:"text-lg font-semibold"},z={class:"text-gray-600"},B={key:0,class:"p-4 mt-2 bg-white rounded-md shadow"},H={class:"flex justify"},J={class:"flex items-center mb-2"},W=["disabled"],K={key:0,class:"text-yellow-500 ml-1"},Q={class:"flex mx-16"},X={class:"text-gray-600"},Y=b(()=>o("hr",{class:"my-2 border-gray-300"},null,-1)),Z={class:"flex justify"},$={class:"flex-none mr-4"},ee={class:"flex items-center"},te=["value","disabled"],se={key:0,class:"text-yellow-500 ml-2"},ie={class:"flex-grow mx-36"},oe={class:"text-gray-600"},ne=b(()=>o("span",{class:"mx-2"},"DHs",-1)),re=b(()=>o("hr",{class:"my-2 border-gray-300"},null,-1)),le={key:0,class:"flex items-center mb-2"},ce={class:"mx-28 text-red-600"},ae={class:"max-w-xl w-full md:w-1/2 mx-3 p-4 bg-white rounded-md shadow"},de=b(()=>o("h3",{class:"text-lg font-semibold"},"Payment Form",-1)),pe={class:"mt-4"},me={class:"mb-2"},ue={class:"font-semibold"},he={class:"flex"},ve={class:"flex-grow mr-2"},fe=b(()=>o("label",{class:"block mb-1"},"Avance",-1)),be={class:"flex-grow"},ye=b(()=>o("label",{class:"block mb-1"},"Reste",-1)),ge={class:"mt-4"},_e=b(()=>o("label",{class:"block mb-1"},"Mode de paiement",-1)),Ee={class:"flex flex-wrap"},xe=["value"],we=["onUpdate:modelValue"],Fe={class:"mt-4"},Pe=b(()=>o("label",{class:"block mb-1"},"Progress",-1)),Ce={class:"relative h-5 bg-gray-300 rounded-md flex items-center"},ke={class:"absolute inset-0 flex items-center justify-center text-white"};function Se(e,s,c,r,t,n){return a(),d("div",null,[o("div",V,[O,f(o("input",{id:"eleveSearch","onUpdate:modelValue":s[0]||(s[0]=i=>t.selectedEleveName=i),onInput:s[1]||(s[1]=(...i)=>n.filterEleves&&n.filterEleves(...i)),onFocus:s[2]||(s[2]=i=>t.filteredEleves=[]),class:"border-0 px-3 py-3 placeholder-blueGray-300 text-blueGray-600 bg-white rounded text-sm shadow focus:outline-none focus:ring w-1/3 ease-linear transition-all duration-150",placeholder:"Search Eleve..."},null,544),[[x,t.selectedEleveName]]),t.filteredEleves.length?(a(),d("ul",q,[(a(!0),d(w,null,F(t.filteredEleves,i=>(a(),d("li",{key:i.id,onClick:m=>n.selectEleve(i),class:"cursor-pointer px-4 py-2 hover:bg-blue-100"},p(i.prenom)+" "+p(i.nom),9,R))),128))])):g("",!0)]),o("div",G,[t.isEleveSelected?(a(),d("div",L,[o("div",{class:"p-4 bg-white rounded-md shadow cursor-pointer",onClick:s[3]||(s[3]=(...i)=>n.toggleDropdown&&n.toggleDropdown(...i))},[o("h3",j,p(t.selectedEleve.prenom)+" "+p(t.selectedEleve.nom),1),o("p",z,p(t.selectedEleve.niveau),1)]),t.isDropdownOpen?(a(),d("div",B,[o("div",H,[o("label",J,[f(o("input",{type:"checkbox","onUpdate:modelValue":s[4]||(s[4]=i=>t.selectedEleve.selectedFraisInscription=i),class:"mr-2 cursor-pointer",disabled:n.isFraisInscriptionExisting(),style:S({"background-color":n.isFraisInscriptionExisting()?"green":""})},null,12,W),[[P,t.selectedEleve.selectedFraisInscription]]),o("span",{class:D({"text-gray-700":!n.isFraisInscriptionPending(),"text-yellow-500":n.isFraisInscriptionPending()})},[_(" Frais d'inscription "),n.isFraisInscriptionPending()?(a(),d("span",K," (pending ...) ")):g("",!0)],2)]),o("div",Q,[o("span",X,p(t.fraisInscriptionPrice)+" DHs",1)])]),Y,o("div",Z,[o("div",$,[(a(!0),d(w,null,F(t.months,(i,m)=>(a(),d("div",{key:m},[o("label",ee,[f(o("input",{type:"checkbox","onUpdate:modelValue":s[5]||(s[5]=u=>t.selectedEleve.selectedMonths=u),value:i,class:"mr-2 cursor-pointer",disabled:n.isMonthExisting(i),style:S({"background-color":n.isMonthExisting(i)?"green":""})},null,12,te),[[P,t.selectedEleve.selectedMonths]]),_(p(i)+" ",1),n.isMonthPending(i)?(a(),d("span",se," (pending ...) ")):g("",!0)])]))),128))]),o("div",ie,[(a(!0),d(w,null,F(t.months,(i,m)=>(a(),d("div",{key:m},[o("span",oe,[_(p(n.getPriceForMonth(i)),1),ne])]))),128))])]),re,n.hasUncompletedPayments?(a(),d("label",le,[f(o("input",{type:"checkbox","onUpdate:modelValue":s[6]||(s[6]=i=>t.selectedEleve.selectedCredit=i),class:"mr-2 cursor-pointer",onChange:s[7]||(s[7]=(...i)=>n.handleCreditCheckboxChange&&n.handleCreditCheckboxChange(...i))},null,544),[[P,t.selectedEleve.selectedCredit]]),_(" Crédit "),o("span",ce," Reste: "+p(n.getTotalUncompletedReste())+" DHs ",1)])):g("",!0)])):g("",!0)])):g("",!0),o("div",ae,[de,o("div",pe,[o("div",me,[_(" Total Amount: "),o("span",ue,p(n.totalAmount),1)]),o("div",he,[o("div",ve,[fe,f(o("input",{"onUpdate:modelValue":s[8]||(s[8]=i=>t.avance=i),type:"text",class:"w-full border rounded-md p-2 focus:outline-none focus:ring focus:border-blue-300 transition ease-in-out duration-300"},null,512),[[x,t.avance]])]),o("div",be,[ye,f(o("input",{"onUpdate:modelValue":s[9]||(s[9]=i=>n.reste=i),type:"text",class:"w-full border rounded-md p-2 focus:outline-none focus:ring focus:border-blue-300 transition ease-in-out duration-300"},null,512),[[x,n.reste]])])]),o("div",ge,[_e,o("div",Ee,[(a(!0),d(w,null,F(t.paymentMethods,(i,m)=>(a(),d("label",{key:m,class:"flex items-center mr-4 mb-2"},[f(o("input",{type:"checkbox","onUpdate:modelValue":s[10]||(s[10]=u=>t.selectedPaymentMethods=u),value:i,class:"mr-2 cursor-pointer"},null,8,xe),[[P,t.selectedPaymentMethods]]),_(" "+p(i)+" ",1),t.selectedPaymentMethods.includes(i)?f((a(),d("input",{key:0,"onUpdate:modelValue":u=>t.paymentMethodPrices[i]=u,type:"text",class:"ml-2 w-20 border rounded-md p-1 focus:outline-none focus:ring focus:border-blue-300 transition ease-in-out duration-300",placeholder:"Price"},null,8,we)),[[x,t.paymentMethodPrices[i]]]):g("",!0),t.selectedPaymentMethods.includes("Chèque")&&i==="Chèque"?f((a(),d("input",{key:1,"onUpdate:modelValue":s[11]||(s[11]=u=>t.referenceNumber=u),type:"text",class:"ml-2 w-40 border rounded-md p-1 focus:outline-none focus:ring focus:border-blue-300 transition ease-in-out duration-300",placeholder:"Réference number"},null,512)),[[x,t.referenceNumber]]):g("",!0)]))),128))])]),o("div",Fe,[Pe,o("div",Ce,[o("div",{class:"absolute h-full bg-green-500 rounded-md",style:S({width:parseInt(t.avance)*100/n.totalAmount+"%"})},null,4),o("div",ke,p(n.totalAmount>0?(parseInt(t.avance)*100/n.totalAmount).toFixed(2):"0.00")+"% ("+p(t.avance)+" / "+p(n.totalAmount||"0.00")+") ",1)])]),o("button",{class:"mt-8 px-4 py-2 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring focus:ring-blue-200 transition ease-in-out duration-300",onClick:s[12]||(s[12]=(...i)=>n.submitPayment&&n.submitPayment(...i))}," Payer ")])])])])}const Ne=I(U,[["render",Se],["__scopeId","data-v-f4ecff51"]]);export{Ne as default};
